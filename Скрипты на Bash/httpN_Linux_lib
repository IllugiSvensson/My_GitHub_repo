#!/bin/bash



#–ù–ï–û–ë–•–û–î–ò–ú–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
cmdLine="$1"
userName=`whoami`
icon="$appfolder/ChromePortable"
diagram=${appfolder%/App}
diagram="$diagram/Diagrams"
#–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º–º –±–æ—Ç–∞
sBotKey='bot1844208783:AAHnDQhkV7kARiLCyus0vxV8jQdAYy4TZcY'	#–í–∞—à api –∫–ª—é—á
nChatId='-1001460258261'									#Id –ø–æ–ª—É—á–∞—Ç–µ–ª—è



function _Now {						#—Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏

	echo $(date +"%d.%m.%Y %H:%M:%S")

}

function BotMsg {					#—Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç—É –≤ —Ç–µ–ª–µ–≥—Ä–∞–º

	local URL="https://api.telegram.org/$sBotKey/sendMessage"
	curl -s -X POST $URL -d chat_id="$nChatId" -d parse_mode=html -d disable_notification=$2 -d text="$1"

}

function FileReader {				#—Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–∞–π–ª–µ

	local sText="$1"				#–°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫
	local sSearchText="$2"			#–ò—Å–∫–æ–º–∞—è —Å—Ç—Ä–æ–∫–∞
	while IFS= read -r line			#–ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏
	do

		[ -z "`echo $line | grep $sSearchText`" ] || {
			#–ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –≤—ã–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É
			auth=`echo $line | egrep -o "\w+[-]{0,1}\w{0,}" | head -1`
			[ "$auth" == "$sSearchText" ] || { continue; }
			echo "$line"

		}

	done < "$sText"

}

function Logger {					#—Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –≤ –ª–æ–≥–∏

	local TIME=$(printf "%-19s" "$(_Now)")
	local ADDRES=$(printf "%-18s" "$1")
	local HOST=$(printf "%-20s" "$2")
	local USER=$(printf "%-42s" "$3")
	local ACT=$(printf "%-18s" "$4")
	echo "$TIME | $ADDRES | $HOST | $USER | $ACT"

}

function ChangesM {					#–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—á–∏—Ç—ã–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

	[ -e "$appfolder/httpN/system/temp/Changes/$name" ] && {	#–û–ø–æ–≤–µ—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

		#–ò—â–µ–º —Ñ–∞–π–ª–∏–∫-–º–µ—Ç–∫—É. –í—ã–≤–æ–¥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ —É–¥–∞–ª—è–µ–º —Ñ–∞–π–ª–∏–∫
		changes=`cat "$appfolder/httpN/system/temp/Changes/$name"`
		zenity --info --title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" --window-icon="$icon/GetStand.png" --text="$changes" --ellipsize --timeout=30
		rm "$appfolder/httpN/system/temp/Changes/$name"

	}

}

function Validator {				#–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä–æ–∫–∏ –ø–æ —à–∞–±–ª–æ–Ω—É

	if [ -z `echo "$1" | egrep -o "$2"` ]
	then

		echo 1		#–°—Ç—Ä–æ–∫–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ —à–∞–±–ª–æ–Ω

	else echo 0
	fi

}

function TrackBinFile {				#–§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∏ —Å–ª–µ–∂–µ–Ω–∏—è –∑–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

	ping -c 3 -W 1 $address >/dev/null
	if [ $? != 0 ]	#–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ç—å. –ï—Å–ª–∏ –Ω–µ –ø–∏–Ω–≥—É–µ—Ç—Å—è —Ö–æ—Å—Ç –∏–ª–∏ —à–ª—é–∑
	then

		message=`echo -e "üë§$name\nÔ∏è‚ö†Ô∏è–ù–µ—É–¥–∞—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ\nüñ•Ô∏è$hostName üïπ$1 ‚è±$(_Now)"`
		BotMsg "$message" 0
		message=`Logger "$userName" "$hostName:$1" "$name" "–•–æ—Å—Ç –∏–ª–∏ —à–ª—é–∑ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"`
		echo -e	"$message" >> "$appfolder/httpN/system/log/log.txt"
		zenity --error --title="–û—à–∏–±–∫–∞" --window-icon="$icon/GetStand.png" --text="–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ö–æ—Å—Ç—É\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –û—Ç–¥–µ–ª –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" --ellipsize --timeout=3

	else									#–ï—Å–ª–∏ –ø–∏–Ω–≥—É–µ—Ç—Å—è, –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

		$2$3 &								#–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –µ–≥–æ PID
		PID=$!
		message=`echo -e "üë§$name\nÔ∏è‚úÖ–ü–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —Ö–æ—Å—Ç—É\nüñ•Ô∏è$hostName üïπ$1 ‚è±$(_Now)"`
		BotMsg "$message" 0
		message=`Logger "$userName" "$hostName:$1" "$name" "–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"`
		echo -e	"$message" >> "$appfolder/httpN/system/log/log.txt"
		#–ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
		t=0
		while true
		do

			sleep 1s							#–û—Ç—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Å–ª–æ–≤–Ω—É—é —Å–µ–∫—É–Ω–¥—É
			t=$(($t + 1))
			#–£—Å–ª–æ–≤–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏
			if [ -z `ps --no-headers $PID` ]	#–ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Ä—É—á–Ω—É—é
			then

				message=`echo -e "üë§$name\nÔ∏è‚¨ÖÔ∏è–û—Ç–∫–ª—é—á–∏–ª—Å—è –æ—Ç —Ö–æ—Å—Ç–∞\nüñ•Ô∏è$hostName üïπ$1 ‚è±$(_Now)"`
				BotMsg "$message" 0
				message=`Logger "$userName" "$hostName:$1" "$name" "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"`
				echo -e	"$message" >> "$appfolder/httpN/system/log/log.txt"
				break

			elif [ -e "$appfolder/httpN/system/temp/Sessions/UPDATE" ]	#–ï—Å–ª–∏ –Ω–∞—á–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
			then

				zenity --warning --title="–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ" --window-icon="$icon/GetStand.png" --text="–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É" --ellipsize --timeout=5
				j=0
				while [ $j -lt 55 ]
				do

					sleep 1s
					j=$(($j + 1))
					[ -z `ps --no-headers $PID` ] && { break; }
					[ -e "$appfolder/httpN/system/temp/Sessions/KILL" ] && { break; }

				done
				kill -9 $PID
				break

			elif [ $t == 30000 ]		#–ï—Å–ª–∏ –¥–æ–∂–¥–∞–ª–∏—Å—å —Ç–∞–π–º–∞—É—Ç–∞
			then

				kill -9 $PID
				message=`echo -e "üë§$name\nÔ∏è‚¨ÖÔ∏è–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞\nüñ•Ô∏è$hostName üïπ$1 ‚è±$(_Now)"`
				BotMsg "$message" 0
				message=`Logger "$userName" "$hostName:$1" "$name" "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"`
				echo -e	"$message" >> "$appfolder/httpN/system/log/log.txt"
				zenity --warning --title="–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ" --window-icon="$icon/GetStand.png" --text="–°–µ—Å—Å–∏—è $hostName:$1\n–∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É" --ellipsize --timeout=3
				break

			fi

			#–§—É–Ω–∫—Ü–∏–∏, –¥–µ–π—Å—Ç–≤—É—é—â–∏–µ –≤–æ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏
			[ -e "$app/system/temp/Sessions/ONLINE" ] && {	#–ì–æ–≤–æ—Ä–∏–º —á—Ç–æ –æ–Ω–ª–∞–π–Ω

				#–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª–∏–∫-–º–µ—Ç–∫—É, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≥–æ–π, –∫–æ—Ç–æ—Ä–∞—è –µ–≥–æ —É–¥–∞–ª–∏—Ç
				touch "$appfolder/httpN/system/temp/PIDS/$name.$hostName.$(($t/60))"

			}
			ChangesM

		done

	fi

}