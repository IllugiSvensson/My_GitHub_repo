#!/bin/bash

#download
#realpath
#zenity
#curl pkexec
#vncviewer putty filezilla
#–¥–ª—è –∫–∏—Ç—Ç–∏ —Å—Å—ã–ª–∫—É –≤ .putty –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ —Å –∫–æ–Ω—Ñ–∏–≥–∞–º–∏
#–Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ + –≤—ã—Ç—è–≥–∏–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å
#scp sitemanager.xml —Å—Å—ã–ª–∫–∞


#–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º–º –±–æ—Ç–∞
sBotKey='bot1844208783:AAHnDQhkV7kARiLCyus0vxV8jQdAYy4TZcY' #–í–∞—à api –∫–ª—é—á
nChatId='-1001460258261'									#Id –ø–æ–ª—É—á–∞—Ç–µ–ª—è
username=`hostname`



function BotMsg {					#—Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç—É –≤ —Ç–µ–ª–µ–≥—Ä–∞–º

	local URL="https://api.telegram.org/$1/sendMessage"
	curl -s -X POST $URL -d chat_id=$2 -d parse_mode=html -d disable_notification=$3 -d text="$4"

}

function Format {					#–§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞

	printf "%-$1s" "$2" 

}

function _Now {						#—Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏

	echo $(date +"%d.%m.%Y %H:%M:%S")

}

function Logger {					#—Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –≤ –ª–æ–≥–∏

	if [ $2 == 1 ]		#–ó–∞–ø–∏—Å—å –ª–æ–≥–∞ –∑–∞–ø—É—Å–∫–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
	then

		local tmpPath=$appfolder/system/log/log.txt	#–ü—É—Ç—å –¥–æ –ª–æ–≥–∞
		local TIME=$(Format 19 "`_Now`")
		local USER=$(Format 42 "$3")
		local ADDRES=$(Format 21 "$4")
		local ACT=$(Format 35 "$1")
		echo "$TIME | $USER | $ADDRES | $ACT | $5" >> $tmpPath

	else				#–ó–∞–ø–∏—Å—å —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ª–æ–≥–∞

		echo $(Format 19 "`_Now`") "| $1" >> $appfolder/system/log/system.txt

	fi

}

function FileReader {				#—Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–∞–π–ª–µ	

	local sText="$1"				#–°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫
	local sSearchText="$2"			#–ò—Å–∫–æ–º–∞—è —Å—Ç—Ä–æ–∫–∞
	while IFS= read -r line			#–ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏
	do

		[ -z "`echo $line | grep $sSearchText`" ] || {
			#–ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –≤—ã–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É
			auth=`echo $line | egrep -o "\w+[-]{0,1}\w{0,}" | head -1`
			[ $auth == $sSearchText ] || { continue; }
			echo $line

		}

	done < $sText

}

function Validator {				#–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä–æ–∫–∏ –ø–æ —à–∞–±–ª–æ–Ω—É

	if [ "$#" = 2 ]		#–ï—Å–ª–∏ –≤—Ç–æ—Ä–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
	then

		if [ -z `echo "$1" | egrep -o "$2"` ]
		then

			echo 1

		else echo 0
		fi

	else echo 0
	fi

}

function AddrToMask {				#–§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞ –≤ –º–∞—Å–∫—É

	case "$1" in			#–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∞–∫—Ç–µ—Ç—ã –Ω–∞ 0
		`echo $1 | egrep -o "(([0-9]{1,3}\.){1}[0].[0].[0])"`)
		echo 255.0.0.0		#–í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å–∫—É
		;;
		`echo $1 | egrep -o "(([0-9]{1,3}\.){2}[0].[0])"`)
		echo 255.255.0.0
		;;
		`echo $1 | egrep -o "(([0-9]{1,3}\.){3}[0])"`)
		echo 255.255.255.0
		;;
		*)
		echo 255.255.255.255
		;;
	esac

}

function ConsolePing {				#–§—É–Ω–∫—Ü–∏—è –ø–∏–Ω–≥–∞

	#sleep 1s		#–ë–µ–∑ –ø–∞—É–∑—ã –ø–æ—á–µ–º—É —Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –Ω–µ –ø–∏–Ω–≥—É–µ—Ç—Å—è
	ping -c 3 -W 1 $1 >/dev/null
	echo $?

}

function RouteAddDel {				#–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞

	[ $1 = 1 ] && {

		pkexec route $2

	}

}

function TrackBinFile {				#–§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∏ —Å–ª–µ–∂–µ–Ω–∏—è –∑–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

	#–í—ã–¥–µ–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤
	name=`echo $autorizedUser | egrep -o "[–∞-—è–ê-–Ø]{1,}\s{1,}[–∞-—è–ê-–Ø]{1,}\(\w+\)"`
	RouteAddDel $4 "add -net $maskAddr netmask $gatemask gw $gateway"	#–°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
	if [[ `ConsolePing $address` != 0 ]]	#–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ç—å. –ï—Å–ª–∏ –Ω–µ –ø–∏–Ω–≥—É–µ—Ç—Å—è
	then

		message=`echo -e "üë§$name\nÔ∏è‚ö†Ô∏è–ù–µ—É–¥–∞—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ\nüñ•Ô∏è$hostName üïπ$1 ‚è±$(_Now)"`
		BotMsg $sBotKey $nChatId 1 "$message"
		Logger "–•–æ—Å—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç" 1 "$name" "$username" "$hostName:$1"
		zenity --error --title=–û—à–∏–±–∫–∞ --ellipsize --text="–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ö–æ—Å—Ç—É.\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –û—Ç–¥–µ–ª –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è." --timeout=3

	else

		$2$3$hostName$5	&					#–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –µ–≥–æ PID
		PID=$!
		message=`echo -e "üë§$name\nÔ∏è‚úÖ–ü–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —Ö–æ—Å—Ç—É\nüñ•Ô∏è$hostName üïπ$1 ‚è±$(_Now)"`
		BotMsg $sBotKey $nChatId 1 "$message"
		Logger "–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ" 1 "$name" "$username" "$hostName:$1"
		#–ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
		t=0
		while true
		do

			sleep 1s						#–û—Ç—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Å–ª–æ–≤–Ω—É—é —Å–µ–∫—É–Ω–¥—É
			t=$(($t + 1))
			#–£—Å–ª–æ–≤–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏
			if [ -z `ps --no-headers $PID` ]	#–ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Ä—É—á–Ω—É—é
			then

				message=`echo -e "üë§$name\nÔ∏è‚¨ÖÔ∏è–û—Ç–∫–ª—é—á–∏–ª—Å—è –æ—Ç —Ö–æ—Å—Ç–∞\nüñ•Ô∏è$hostName üïπ$1 ‚è±$(_Now)"`
				BotMsg $sBotKey $nChatId 1 "$message"
				Logger "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã" 1 "$name" "$username" "$hostName:$1"
				break

			elif [ -e $appfolder/system/temp/Sessions/UPDATE ]	#–ï—Å–ª–∏ –Ω–∞—á–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
			then

				zenity --warning --title=–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ --text="–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É.\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É." --ellipsize --timeout=5
				j=0
				while [ $j -lt 55 ]
				do

					sleep 1s
					j=$(($j + 1))
					[ -z `ps --no-headers $PID` ] && { break; }
					[ -e "$appfolder/system/temp/Sessions/KILL" ] && { break; }

				done
				kill -9 $PID
				break

			elif [ $t == 30000 ]		#–ï—Å–ª–∏ –¥–æ–∂–¥–∞–ª–∏—Å—å —Ç–∞–π–º–∞—É—Ç–∞
			then

				kill -9 $PID
				message=`echo -e "üë§$name\nÔ∏è‚¨ÖÔ∏è–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞\nüñ•Ô∏è$hostName üïπ$1 ‚è±$(_Now)"`
				BotMsg $sBotKey $nChatId 1 "$message"
				Logger "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞" 1 "$name" "$username" "$hostName:$1"
				zenity --warning --title=–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ --ellipsize --text="–°–µ—Å—Å–∏—è $hostName:$1\n–∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É" --timeout=3

			fi

			#–§—É–Ω–∫—Ü–∏–∏, –¥–µ–π—Å—Ç–≤—É—é—â–∏–µ –≤–æ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏
			[ -e $appfolder/system/temp/Sessions/ONLINE ] && {			#–ì–æ–≤–æ—Ä–∏–º —á—Ç–æ –æ–Ω–ª–∞–π–Ω

				#–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª–∏–∫-–º–µ—Ç–∫—É, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≥–æ–π, –∫–æ—Ç–æ—Ä–∞—è –µ–≥–æ —É–¥–∞–ª–∏—Ç
				touch "$appfolder/system/temp/PIDS/$name.$hostName.$(($t/60))"

			}

		done

	fi

	#–ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏ —Ä–∞–±–æ—Ç—É –∏–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è, –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∑–∞ —Å–æ–±–æ–π
	zenity --warning --text=`pgrep -f httpN_Linux | wc -w`
	[ `pgrep -f httpN_Linux | wc -w` -le 2 ] && {	#–ï—Å–ª–∏ —Ñ–∞–π–ª –æ–¥–∏–Ω (–Ω–∞—à —Ñ–∞–π–ª)

		zenity --warning --text=lol
		RouteAddDel $4 "del -net $maskAddr netmask $gatemask gw $gateway" #–£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã

	}

}