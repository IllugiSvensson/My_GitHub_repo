#!/bin/bash



#–ù–ï–û–ë–•–û–î–ò–ú–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
appfolder=`realpath $0`
appfolder=${appfolder%/httpN/httpN_Linux}
. $appfolder/httpN/system/httpN_linux_lib
#–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π



#–ü–†–û–í–ï–†–ö–ê –ò –ó–ê–ü–£–°–ö BIN –§–ê–ô–õ–ê
[ -e "$appfolder/httpN/system/temp/Sessions/UPDATE" ] && {	#–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

	zenity --warning --title="–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ" --window-icon="$icon/GetStand.png" --text="–í–µ–¥—É—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ" --ellipsize --timeout=3
	exit

}
[ -z "$cmdLine" ] && {										#–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ –Ω–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

	#–°—Ç—Ä–æ–∏–º –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
	input=$(zenity --entry --title="httpn –∑–∞–ø—É—Å–∫" --window-icon="$icon/GetStand.png" --width=256 --height=200 --text="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ VNC, KIT –∏–ª–∏ SCP –∏ \n—Ö–æ—Å—Ç–Ω–µ–π–º –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é\n–ü—Ä–∏–º–µ—Ä: VNC default" --entry-text="–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Å—Ç–Ω–µ–π–º" --ok-label="–ó–∞–ø—É—Å–∫" --cancel-label="–í—ã—Ö–æ–¥")
	if [ $? == 0 ]		#–†–∞–∑–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
	then

		cmdLine="httpn://"${input:0:3}" "${input#${input:0:4}}

	else exit;
	fi

}



#–ü–†–û–í–ï–†–ö–ê –ò–ú–ï–ù–ò –ò –ü–†–ê–í –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ü–û –°–ü–ò–°–ö–£ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
[ -e "/home/$userName/" ] || {								#–ï—Å–ª–∏ –∏–º—è –∏–ª–∏ –∫–∞—Ç–∞–ª–æ–≥ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è

	message=`echo -e "üõë<b>–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</b>\n‚ùå–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ\n‚è±$(_Now)"`
	BotMsg "$message" 0
	message=`printf "%-19s" "$(_Now) | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."`
	echo -e	"$message" >> "$appfolder/httpN/system/log/system.txt"
	zenity --error --title="–û—à–∏–±–∫–∞" --window-icon="$icon/GetStand.png" --text="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –û—Ç–¥–µ–ª –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" --ellipsize --timeout=3
	exit

}
autorizedUser="`FileReader $appfolder/httpN/system/USERS $userName`"	#–ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ
#–ó–∞—Ö–≤–∞—Ç–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –≤ –≤–∏–¥–µ –∫–æ–¥–∞ —Å—Ç–æ–π–∫–∏-—Å—Ç–µ–Ω–¥–∞.
hostName=`echo $cmdLine | sed "s/%20/ /"`
hostName=`echo ${hostName#${hostName:0:12}}`					#–í—ã–±–∏—Ä–∞–µ–º –∏–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
binFile=`echo $cmdLine | grep -Eo "VNC|KIT|SCP|FBC|ACH"`
	[ `echo ${#autorizedUser}` == 0 ] && {	#–ï—Å–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å–ø–∏—Å–∫–µ, –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º —Ä–∞–±–æ—Ç—É

		message=`echo -e "üë§<b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>\nÔ∏è‚ö†Ô∏è–ü—ã—Ç–∞–ª—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ö–æ—Å—Ç—É\nüñ•Ô∏è$hostName üïπ$eks ‚è±$(_Now)"`
		BotMsg "$message" 0
		message=`Logger "$userName" "$hostName:$binFile" "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å(unknown)" "–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –≤—Ö–æ–¥"`
		echo -e	"$message" >> "$appfolder/httpN/system/log/log.txt"
		zenity --error --title="–û—à–∏–±–∫–∞" --window-icon="$icon/GetStand.png" --text="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –û—Ç–¥–µ–ª –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" --ellipsize --timeout=3
		exit

	}
#–í—ã–¥–µ–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤
name=`echo "$autorizedUser" | egrep -o "[–∞-—è–ê-–Ø]{1,}\s{1,}[–∞-—è–ê-–Ø]{1,}\(\w+\)" | head -1`
ChangesM	#–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
	[ `echo $cmdLine | egrep -o "FBC"` == "FBC" ] && {		#–û–∫–æ—à–∫–æ –¥–ª—è —Ñ–∏–¥–±–µ–∫–∞

		stend=`echo $cmdLine | sed "s/%20/ /"`
		stend=`echo ${stend#${stend:0:12}}`
		feedback=$(zenity --entry --title="–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å" --window-icon="$icon/GetStand.png" --width=256 --height=200 --text="–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–æ–∂–µ—Ç–µ \n–Ω–∞–ø–∏—Å–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –≤ —ç—Ç–æ–π —Ñ–æ—Ä–º–µ\n–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –°–º–∏—Ä–Ω–æ–≤ –ê.–î. –û–¢" --entry-text="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" --ok-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" --cancel-label="–í—ã—Ö–æ–¥")
		[ $? == 0 ] || { exit; }
		AchievmentTracker "$name" 7
		message=`echo -e "@IllugiSven\nüë§$name\nÔ∏è‚ö†Ô∏è–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ\nüñ•Ô∏è–°—Ç–µ–Ω–¥: $stend ‚è±$(_Now)"`
		BotMsg "$message" 0
		message=`printf "%-19s" "$(_Now) | $name. –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Å—Ç–µ–Ω–¥—É: $stend. $feedback"`
		echo -e	"$message" >> "$appfolder/httpN/system/log/system.txt"
		zenity --info --title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" --window-icon="$icon/GetStand.png" --text="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ\n—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É" --ellipsize --timeout=3
		exit

	}
	[ `echo $cmdLine | egrep -o "ACH"` == "ACH" ] && {		#–û–∫–æ—à–∫–æ –¥–ª—è –∞—á–∏–≤–æ–≤

		AchievmentTracker "$name" 1
		AchievmentTracker "$name" "show"
		exit

	}

#–ü—Ä–æ–≤–µ—Ä–∏–º –ø—Ä–∞–≤–∞ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –ï—Å–ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ –Ω–µ –Ω–∞–π–¥–µ–º –∏–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –∏–ª–∏ ADMIN, —Ç–æ –≤—ã–¥–∞–µ–º –æ—à–∏–±–∫—É.
	if [[ -z `echo $autorizedUser | grep "$hostName"` && -z `echo $autorizedUser | grep "ADMIN"` ]]
	then

		AchievmentTracker "$name" 9
		zenity --warning --title="–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ" --window-icon="$icon/GetStand.png" --text="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤\n–Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ $hostName" --ellipsize --timeout=3
		exit

	fi



#–ü–û–õ–£–ß–ï–ù–ò–ï –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ö–û–ú–ü–¨–Æ–¢–ï–†–ï –°–¢–ï–ù–î–ê –ò–ó –ö–û–ú–ê–ù–î–ù–û–ô –°–¢–†–û–ö–ò –ó–ê–ü–£–°–ö–ê
namehost="`FileReader $appfolder/httpN/system/HOSTS $hostName`" 	#–ü–æ–ª—É—á–∏–º —Å—Ç—Ä–æ–∫—É —Å —Ö–æ—Å—Ç–æ–º –∏ –∞–¥—Ä–µ—Å–æ–º
hn=`echo $namehost | egrep -o "\w+" | head -1`
#–ò—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö–æ—Å—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ —Ö–æ—Å—Ç–æ–≤
	if [[ -z "$namehost" || `echo "${#hn}"` != `echo "${#hostName}"` ]]	#–ï—Å–ª–∏ –∏–º—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
	then

		message=`echo -e "üõë<b>–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</b>\nÔ∏è‚ùå–ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ\nüñ•Ô∏è$hostName ‚è±$(_Now)"`
		BotMsg "$message" 0
		message=`printf "%-19s" "$(_Now) | –ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ $hostName –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ö–µ–º—É, —Å–ø–∏—Å–æ–∫ –∏ —Å—Ç—Ä–æ–∫—É –∑–∞–ø—É—Å–∫–∞."`
		echo -e	"$message" >> "$appfolder/httpN/system/log/system.txt"
		zenity --error --title="–û—à–∏–±–∫–∞" --window-icon="$icon/GetStand.png" --text="–ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –û—Ç–¥–µ–ª –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" --ellipsize --timeout=3
		exit

	fi
#–†–∞–∑–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É –∞–¥—Ä–µ—Å–∞ –∏–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞
#–ü—Ä–æ–≤–µ—Ä–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å ip-–∞–¥—Ä–µ—Å—Å–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —á–∞—Å—Ç–Ω—ã–º —Å–µ—Ç—è–º ipv4
#"^((10|192|127|169)\.){1}((25[0..5]|(2[0..4]\d|1{0,1}\d){0,1}\d)(\.?)){3}$" –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–Ω–∞—á–∞—â–∏–µ –Ω—É–ª–∏
addcheck=`Validator "$namehost" "[A](([0-9]{1,3}\.){3}[0-9]{1,3})"`
portcheck=`Validator "$namehost" "[S][0-9]{2,5}"`
passcheck=`Validator "$namehost" "[#]\S+"`
	[[ $(($addcheck + $portcheck + $passcheck)) == 0 ]] || {

		message=`echo -e "üõë<b>–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</b>\nÔ∏è‚ùå–û—à–∏–±–∫–∞ –≤ —Å–ø–∏—Å–∫–µ —Ö–æ—Å—Ç–æ–≤\nüñ•Ô∏è$hostName ‚è±$(_Now)"`
		BotMsg "$message" 0
		message=`printf "%-19s" "$(_Now) | –í –∑–∞–ø–∏—Å–∏ –∞–¥—Ä–µ—Å–∞ $hostName –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø–∏—Å—å –≤ —Å–ø–∏—Å–∫–µ —Ö–æ—Å—Ç–æ–≤."`
		echo -e	"$message" >> "$appfolder/httpN/system/log/system.txt"
		zenity --error --title="–û—à–∏–±–∫–∞" --window-icon="$icon/GetStand.png" --text="–û—à–∏–±–∫–∞ –≤ —Å–ø–∏—Å–∫–µ —Ö–æ—Å—Ç–æ–≤\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –û—Ç–¥–µ–ª –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" --ellipsize --timeout=3
		exit

	}
addcheck=`echo "$namehost" | egrep -o "[A]((\w+\.){3}\w+)"`			#–ü–æ–ª—É—á–∞–µ–º —à–∞–±–ª–æ–Ω –∞–¥—Ä–µ—Å–∞
portcheck=`echo "$namehost" | egrep -o "[S][0-9]{2,5}"`				#–ü–æ–ª—É—á–∞–µ–º —à–∞–±–ª–æ–Ω –ø–æ—Ä—Ç–∞
passcheck=`echo "$namehost" | egrep -o "[#]\S+"`					#–ü–æ–ª—É—á–∞–µ–º —à–∞–±–ª–æ–Ω –ø–∞—Ä–æ–ª—è
address=`echo ${addcheck#${addcheck:0:1}}`							#–ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
port=`echo ${portcheck#${portcheck:0:1}}`							#–ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
pass=`echo ${passcheck#${passcheck:0:1}}`							#–ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
pass=`echo "$pass" | base64 -d`
pass=`echo "$pass" | sed "s/$hostName//"`
pass=`echo "$pass" | sed "s/$addcheck//"`
pass=`echo "$pass" | sed "s/$portcheck//"`



#–ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ò –ù–ê–ë–õ–Æ–î–ï–ù–ò–ï –ó–ê –•–û–î–û–ú –†–ê–ë–û–¢–´
#–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –Ω—É–∂–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
case $binFile in

	"VNC")
		binFile="$appfolder/vnc/vncviewer"
		config=" -config $appfolder/vnc/config/$hostName.vnc"
		TrackBinFile "VNC" "$binFile" "$config" 3
		;;
	"KIT")
		binFile="$appfolder/kitty/putty"
		[ $port != 22 ] && { port=$(($port - 1)); }
		config=" root@$address -P $port -pw $pass"
		TrackBinFile "Putty" "$binFile" "$config" 4
		;;
	"SCP")
		binFile="$appfolder/winscp/filezilla"
		[ $port != 22 ] && { port=$(($port - 2)); }
		config=" sftp://root:$pass@$address:$port"
		TrackBinFile "FileZilla" "$binFile" "$config" 5
		;;
	*)
		message=`echo -e "üõë<b>–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</b>\nÔ∏è‚ùå–û—à–∏–±–∫–∞ –≤ —Å—Å—ã–ª–∫–µ –Ω–∞ —Å—Ö–µ–º–µ\nüñ•Ô∏è$hostName ‚è±$(_Now)"`
		BotMsg "$message" 0
		message=`printf "%-19s" "$(_Now) | –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ $binFile –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ö–µ–º—É, –∑–∞–ø–∏—Å–∏ –∏ –¥–∏—Å–∫ GetStand"`
		echo -e	"$message" >> "$appfolder/httpN/system/log/system.txt"
		zenity --error --title="–û—à–∏–±–∫–∞" --window-icon="$icon/GetStand.png" --text="–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –û—Ç–¥–µ–ª –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" --ellipsize --timeout=3
		exit
		;;

esac